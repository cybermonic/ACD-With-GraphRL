<head>
    <style> body { margin: 0; } </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="//unpkg.com/force-graph"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <!--<script src="../../dist/force-graph.js"></script>-->
  </head>
  
  <body>
    <div>
      <div class="row p-3 mb-2 bg-primary text-white">
        <h3>KEEP Viewer</h1>
      </div>
    </div>
    <div class="row p-3 mb-2 bg-light">
      <div class="col-6">
        <button class="btn btn-primary" onClick=dostuff()>Next Step</button>
        <button class="btn btn-secondary" onClick=reset()>Reset</button>
        <button class="btn btn-secondary" onClick=jumpToStep()>Jump to step:</button>
        <input type="text" id="jumpStep" name="jumpStep">
        <button class="btn btn-secondary" onClick=update_agent()>Update Configuration</button>
      </div>
      <div class="col-2">
        <span>Current Step: <a id="steps">0</a></span>
      </div>
      <div class="col-2">
        <span>Blue Score: <a id="blueScoreTotal">0.0</a></span>
      </div>
      <div class="col-2">
        <span>Red Score: <a id="redScoreTotal">0.0</a></span>
      </div>
      <div class="col-2" style="background-color:rgba(117, 170, 255,0.5);">
        <p>Blue Agent:</p>
        <div class="form-check">
          <input class="form-check-input position-static" type="radio" id="transductive" name="blueAgent" value="transductive" checked>
          <label for="transductive">KEEP (transductive)</label><br>
          <input class="form-check-input position-static" type="radio" id="inductiveSimple" name="blueAgent" value="inductiveSimple">
          <label for="inductiveSimple">KEEP (inductive-simple)</label><br>
          <input class="form-check-input position-static" type="radio" id="inductiveSelfAttn" name="blueAgent" value="inductiveSelfAttn">
          <label for="inductiveSelfAttn">KEEP (inductive-self-attention)</label><br>
        </div>
      </div>
      <div class="col-2" style="background-color: rgba(255, 117, 117,0.5)">
        <p>Red Agent Selection:</p>
        <div class="form-check">
        <input class="form-check-input position-static" type="radio" id="bline" name="agent" value="bline" checked>
        <label for="bline">BLine</label><br>
        <input class="form-check-input position-static" type="radio" id="meander" name="agent" value="meander">
        <label for="meander">Meander</label><br>
        </div>
      </div>
      <div class="col-6" style="background-color: rgba(227, 255, 252,0.5)">
        <p>Environment:</p>
        <div class="row">
          <div class="col-6">
            <input checked type="radio" id="cage2" name="environment" value="cage2.yaml" checked>
            <label for="cage2">cage2</label>
          </div>
          <div class="col-6">
            <input type="radio" id="cage2extraserver" name="environment" value="extra_enterprise.yaml">
            <label for="cage2extraserver">cage2 - extra enterprise server</label>
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <input type="radio" id="cage2extrauser" name="environment" value="extra_user.yaml">
            <label for="cage2extrauser">cage2 - extra user workstation</label>
          </div>
          <div class="col-6">
            <input type="radio" id="cage2lessserver" name="environment" value="minus_enterprise.yaml">
            <label for="cage2lessserver">cage2 - less enterprise server</label>
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <input type="radio" id="cage2lessuser" name="environment" value="minus_user.yaml">
            <label for="cage2lessuser">cage2 - less user workstation</label><br>
          </div>
          <div class="col-6">
            <input type="radio" id="cage2maxusers" name="environment" value="max_users.yaml">
          <label for="cage2maxusers">cage2 - max users</label>
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <input type="radio" id="cage2minusers" name="environment" value="min_users.yaml">
            <label for="cage2minusers">cage2 - min users</label><br>
          </div>
        </div>
      </div>
      <div class="col-2">
        <p>Mode:</p>
        <input type="radio" id="live" name="mode" value="live" checked>
        <label for="live">Live</label><br>
        <input type="radio" id="historic" name="mode" value="historic">
        <label for="historic">Historic</label><br>
      </div>
      <div class="col-6">
        <p>Previous Blue Agent Action:</p>
        <p style="color: blue;"><a id="actionBlue"></a></p>
      </div>
      <div class="col-6">
        <p>Previous Red Agent Action: </p>
        <p style="color: red;"><a id="actionRed"></a></p>
      </div>
    </div>
    <div id="graph"></div>
    
  
    <script>
      var localData = {"nodes":[], "links":[]}

      function comparseNodes(n1, n2) {
        return n1['id'] == n2['id']
      }

      function jumpToStep() {
        var jumpStep = parseInt(document.getElementById('jumpStep').value)
        document.getElementById("steps").innerHTML = jumpStep
        fetch('api/step/'+jumpStep).then(res => res.json()).then(newdata => {
          document.getElementById("actionBlue").innerHTML = newdata['action'].split(",")[0] 
          document.getElementById("actionRed").innerHTML = newdata['action'].split(",")[1]
          console.log("Current data:")
          console.log(localData)

          console.log("New data:")
          console.log(newdata)

          // update local representation
          // note data here is localData
          // This sort of works but also doesnt...
          // graph structure looks right but force directed layout gets weird.. 
          // const nodesToAdd = _.map(_.filter(newdata['nodes'], node => !_.includes(_.map(localData.nodes, n => n.id), node.id)), n => JSON.parse(JSON.stringify(n)))
          // const nodesToInclude = _.map(_.filter(newdata['nodes'], node => _.includes(_.map(localData.nodes, n => n.id), node.id)), n => n.id)

          // const linksToAdd = _.map(_.filter(newdata['links'], link => !_.includes(_.map(localData.links, l => `${l.source},${l.target}`), `${link.source},${link.target}`)), l => JSON.parse(JSON.stringify(l)))
          // const linksToInclude = _.map(_.filter(newdata['links'], link => _.includes(_.map(localData.links, l => `${l.source},${l.target}`), `${link.source},${link.target}`)), l => `${l.source},${l.target}`)

          // console.log("Nodes to add:")
          // console.log(nodesToAdd)

          // const newGraphData = { nodes: [...localData.nodes.filter(obj => nodesToInclude.includes(obj['id'])), ...nodesToAdd], links: [...localData.links.filter(obj => linksToInclude.includes(`${obj['source']},${obj['target']}`)), ...linksToAdd] }
          
          // localData['nodes'] = newGraphData['nodes']
          // localData['links'] = newGraphData['links']
          
          // This doesn't actually work because nodes are objects and the objects are not equal
          let nremain = localData['nodes'].filter(x => newdata['nodes'].includes(x));
          let ntoRemove = localData['nodes'].filter(x => !newdata['nodes'].includes(x));
          let ntoAdd = newdata['nodes'].filter(x => !localData['nodes'].includes(x));

          console.log("num remaining nodes")
          console.log(nremain.length)

          let eremain = localData['links'].filter(x => newdata['links'].includes(x));
          let etoRemove = localData['links'].filter(x => !newdata['links'].includes(x));
          let etoAdd = newdata['links'].filter(x => !localData['links'].includes(x));

          // update local data
          // in theory, anything in the remain should not be re-rendered because React magic
          localData['nodes'] = [ ...nremain, ...ntoAdd]
          localData['links'] = [ ...eremain, ...etoAdd]

          console.log(localData)
          const elem = document.getElementById('graph');
          const Graph = ForceGraph()(elem)
            .graphData(localData)
            .nodeId('id')
            .nodeVal('val')
            .nodeLabel('label')
            .nodeAutoColorBy('group')
            .linkSource('source')
            .linkTarget('target')
            .nodeCanvasObjectMode(() => "after")
            .nodeCanvasObject(drawNode);
                });
        
      }
      

      function update_agent() {
        var selectedBlueAgent = document.querySelector('input[name="blueAgent"]:checked');
        var selectedRedAgent = document.querySelector('input[name="agent"]:checked');
        var selectedEnvironment = document.querySelector('input[name="environment"]:checked');
        var selectedMode = document.querySelector('input[name="mode"]:checked');
        // client makes request to server to change configuration
        fetch('api/redagent/'+selectedRedAgent.value)
          .then(fetch('api/blueagent/'+selectedBlueAgent.value))
          .then(fetch('api/environment/'+selectedEnvironment.value))
          .then(fetch('api/mode/'+selectedMode.value))

      }

      function reset() {
        fetch('api/reset').then(res => res.json()).then(data => {
          localData['nodes'] = []
          localData['links'] = []
          document.getElementById("steps").innerHTML = 0;
          document.getElementById('blueScoreTotal').innerHTML = "0.0"
          document.getElementById('redScoreTotal').innerHTML = "0.0"
          document.getElementById("actionBlue").innerHTML = ""
          document.getElementById("actionRed").innerHTML = ""

          const elem = document.getElementById('graph');
          const Graph = ForceGraph()(elem)
            .graphData(localData)
            .height(600)
            .nodeId('id')
            .nodeVal('val')
            .nodeLabel('label')
            .linkColor(() => 'rgba(0,0,0,0.6)')
            .nodeAutoColorBy('group')
            .linkSource('source')
            .linkTarget('target')
            .nodeCanvasObjectMode(() => "after")
            .nodeCanvasObject(drawNode);
          });
      }

      const drawNode = (node, ctx) => {

        if (node.user_compromise || node.id === 'User0') {
          ctx.beginPath();
          ctx.arc(node.x, node.y, 6, 0, 2 * Math.PI, false);
          ctx.lineWidth = 2
          ctx.strokeStyle = "red"
          ctx.stroke();
        }
        if (node.crown_jewel) {
          ctx.beginPath();
          ctx.arc(node.x, node.y, 6, 0, 2 * Math.PI, false);
          ctx.lineWidth = 2
          ctx.strokeStyle = "blue"
          ctx.stroke();
        }


        let label = node.id
        const fontSize = 8
        ctx.font = `${fontSize}px "Montserrat", Helvetica, Arial, serif`
        const textWidth = ctx.measureText(label).width
        const bckgDimensions = [textWidth, fontSize].map(
          (n) => n + (fontSize * 0.5)
        ) // some padding

        // Node label
        ctx.textAlign = "center"
        ctx.textBaseline = "middle"
        //ctx.fillStyle = node.color
        ctx.fillStyle = "black"
        ctx.fillText(label, node.x, node.y)
      }

      function dostuff() {
        var steps = parseInt(document.getElementById("steps").innerHTML)
        document.getElementById("steps").innerHTML = steps+1
        fetch('api/step').then(res => res.json()).then(newdata => {
          document.getElementById("actionBlue").innerHTML = newdata['action'].split(",")[0] + " Reward: " +  newdata['reward']['Blue']
          document.getElementById("actionRed").innerHTML = newdata['action'].split(",")[1] + " Reward: " +  newdata['reward']['Red']

          var blueLastTotal = parseFloat(document.getElementById("blueScoreTotal").innerHTML)
          var redLastTotal = parseFloat(document.getElementById("redScoreTotal").innerHTML)
          
          var blueNewTotal = blueLastTotal + parseFloat(newdata['reward']['Blue'])
          var redNewTotal = redLastTotal + parseFloat(newdata['reward']['Red'])
          document.getElementById("blueScoreTotal").innerHTML = blueNewTotal.toFixed(1)
          document.getElementById("redScoreTotal").innerHTML = redNewTotal.toFixed(1)


          console.log("Current data:")
          console.log(localData)

          console.log("New data:")
          console.log(newdata)

          // update local representation
          // note data here is localData
          // This sort of works but also doesnt...
          // graph structure looks right but force directed layout gets weird.. 
          // const nodesToAdd = _.map(_.filter(newdata['nodes'], node => !_.includes(_.map(localData.nodes, n => n.id), node.id)), n => JSON.parse(JSON.stringify(n)))
          // const nodesToInclude = _.map(_.filter(newdata['nodes'], node => _.includes(_.map(localData.nodes, n => n.id), node.id)), n => n.id)

          // const linksToAdd = _.map(_.filter(newdata['links'], link => !_.includes(_.map(localData.links, l => `${l.source},${l.target}`), `${link.source},${link.target}`)), l => JSON.parse(JSON.stringify(l)))
          // const linksToInclude = _.map(_.filter(newdata['links'], link => _.includes(_.map(localData.links, l => `${l.source},${l.target}`), `${link.source},${link.target}`)), l => `${l.source},${l.target}`)

          // console.log("Nodes to add:")
          // console.log(nodesToAdd)

          // const newGraphData = { nodes: [...localData.nodes.filter(obj => nodesToInclude.includes(obj['id'])), ...nodesToAdd], links: [...localData.links.filter(obj => linksToInclude.includes(`${obj['source']},${obj['target']}`)), ...linksToAdd] }
          
          // localData['nodes'] = newGraphData['nodes']
          // localData['links'] = newGraphData['links']
          
          // This doesn't actually work because nodes are objects and the objects are not equal
          let nremain = localData['nodes'].filter(x => newdata['nodes'].includes(x));
          let ntoRemove = localData['nodes'].filter(x => !newdata['nodes'].includes(x));
          let ntoAdd = newdata['nodes'].filter(x => !localData['nodes'].includes(x));

          console.log("num remaining nodes")
          console.log(nremain.length)

          let eremain = localData['links'].filter(x => newdata['links'].includes(x));
          let etoRemove = localData['links'].filter(x => !newdata['links'].includes(x));
          let etoAdd = newdata['links'].filter(x => !localData['links'].includes(x));

          // update local data
          // in theory, anything in the remain should not be re-rendered because React magic
          localData['nodes'] = [ ...nremain, ...ntoAdd]
          localData['links'] = [ ...eremain, ...etoAdd]

          console.log(localData)
          const elem = document.getElementById('graph');
          const Graph = ForceGraph()(elem)
            .graphData(localData)
            .height(600)
            .nodeId('id')
            .nodeVal('val')
            .nodeLabel('label')
            .linkColor(() => 'rgba(0,0,0,0.6)')
            .nodeAutoColorBy('group')
            .linkSource('source')
            .linkTarget('target')
            .nodeCanvasObjectMode(() => "after")
            .nodeCanvasObject(drawNode);
                });
        
      }
    </script>
  </body>